

# 教育项目

商业模式：

   两种最典型的模式

+ **B2C**：商家到用户模式，通常分为两个角色，**管理员和普通用户**  在线教育项目使用的就是**B2C模式**。
+ **B2B2C**：商家到商家到用户模式，比如京东。

### 功能模块

后台模块：

1. 讲师管理模块
2. 课程分类管理模块
3. 课程管理模块
4. 统计分析模块
5. 订单管理模块
6. banner管理模块（轮播图，幻灯片等）
7. 权限管理模块

前台模块：

1. 首页数据展示
2. 讲师列表和详情
3. 课程列表和课程详情
4. 登录注册功能
5. 微信扫码登录
6. 微信的扫码支付

### 项目技术栈

**本项目采用前后端分离开发**

**后端技术栈**：

- springboot           
- springCloud         
- MybatisPlus         
- springSecurity     
- jwt
- redis
- maven
- OAuth2
- easyExcel 

**前端技术栈**：

- vue
- element-ui
- axios
- node.js

**其他技术栈：**

- 阿里云oss
- 阿里云视频点播服务
- 阿里云短信服务
- 微信支付和登录
- docker容器
- git
- Jenkins

#### MybatisPlus 

**MybatisPlus**是一个Mybatis的增强工具，在Mybatis的基础上，只做增强不做改变，为简化开发，提高效率而生。

![image-20201127101037286](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127101037286.png)

#### mp入门

1. 创建数据库，创建数据库表，添加数据。

```sql
DROP ​TABLE IF EXISTS user
CREATE TABLE user
(
    id BIGINT(20) NOT NULL COMMENT '主键ID',
    name VARCHAR(30) NULL DEFAULT NULL COMMENT '姓名',
    age INT(11) NULL DEFAULT NULL COMMENT '年龄',
    email VARCHAR(50) NULL DEFAULT NULL COMMENT '邮箱',
    PRIMARY KEY (id)
);
INSERT INTO user (id, name, age, email) VALUES
(1, 'Jone', 18, 'test1@baomidou.com'),
(2, 'Jack', 20, 'test2@baomidou.com'),
(3, 'Tom', 28, 'test3@baomidou.com'),
(4, 'Sandy', 21, 'test4@baomidou.com'),
(5, 'Billie', 24, 'test5@baomidou.com');
```

   1.创建一个springboot工程

2. ![image-20201127102738499](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127102738499.png)

3. 引入相关的依赖

   ```xml
       <dependencies>
           <dependency>
               <groupId>org.springframework.boot</groupId>
               <artifactId>spring-boot-starter</artifactId>
           </dependency>
           <dependency>
               <groupId>org.springframework.boot</groupId>
               <artifactId>spring-boot-starter-test</artifactId>
               <scope>test</scope>
               <exclusions>
                   <exclusion>
                       <groupId>org.junit.vintage</groupId>
                       <artifactId>junit-vintage-engine</artifactId>
                   </exclusion>
               </exclusions>
           </dependency>
           <!--mybatis-plus-->
           <dependency>
               <groupId>com.baomidou</groupId>
               <artifactId>mybatis-plus-boot-starter</artifactId>
               <version>3.0.5</version>
           </dependency>
           <!--mysql-->
           <dependency>
               <groupId>mysql</groupId>
               <artifactId>mysql-connector-java</artifactId>
           </dependency>
           <!--lombok用来简化实体类-->
           <dependency>
               <groupId>org.projectlombok</groupId>
               <artifactId>lombok</artifactId>
           </dependency>
       </dependencies>
   ```

   

4.idea中安装Lombok插件

![image-20201127103943479](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127103943479.png)

5.配置properties文件连接数据库

```properties
#数据库连接配置
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/user?useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimeZone=GMT%2B
spring.datasource.username=root
spring.datasource.password=123456
#Mybatis日志配置
mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```

6.创建实体类包名pojo，创建user实体类

![image-20201127105308628](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127105308628.png)

7.创建包名mapper，创建userMapper接口，继承BaseMapper接口

![image-20201127105400265](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127105400265.png)

8.增加@MapperScan注解，指向mapper的包地址

```java
@SpringBootApplication
@MapperScan("com.yao.mpdemo.mapper")
```

9.使用测试类测试功能，查询全部数据

![image-20201127140954738](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127140954738.png)

![image-20201127141002739](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127141002739.png)

#### 主键策略

- 数据库自增策略
- UUID 每次都会操作都会生成一个随机的唯一的值
- reids生成id
- Twitter的snowflake算法（雪花算法）![image-20201127145407232](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127145407232.png)

##### 自动填充：

user表中增加创建时间，修改时间字段，不用自己set添加值，使用mp的方式实现自动填充

1. 在实体类中需要进行自动填充的属性添加注解 @TableField![image-20201127151549133](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127151549133.png)
2. 创建MybatisHandler类实现MetaObjectHandler接口![image-20201127152413252](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127152413252.png)
3. 测试添加，修改

![image-20201127152833756](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127152833756.png)

#### 乐观锁：

 主要解决：丢失更新问题

如果不考虑事务隔离性，产生读问题？

脏读         不可重复读         幻读

写问题：丢失更新问题

1. 表中添加乐观锁字段version,对应实体类中添加属性，并将该属性加上@Version注解![image-20201127172529488](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201127172529488.png)

2. 配置乐观锁插件

   ```java
   /**
    * @author yaoheng
    * @date 2020/11/27 17:27
    */
   @Configuration
   @MapperScan("com.yao.mpdemo.mapper")
   public class MybatisConfig {
       /**
        * 乐观锁插件
        * @return
        */
       @Bean
       public OptimisticLockerInterceptor optimisticLockerInterceptor(){
           return new OptimisticLockerInterceptor();
       }
   }
   ```

   

3. 测试乐观锁

   ```java
       //乐观锁测试
       @Test
       void update() {
           //先查询
           User user = userMapper.selectById(1333612685794861057L);
           user.setAge(100);
           int i = userMapper.updateById(user);
           System.out.println("影响的行数：" + i);
       }
   ```

   #### mp简单查询

   #### 多个id的批量查询 

```java
    //id批量查询
    @Test
    void textSelectByIds() {
        List<User> users = userMapper.selectBatchIds(Arrays.asList(1L, 2L, 3L));
        users.forEach(System.out::println);
    }
```

#### mp实现分页

配置分页插件

```java
    /**
     * 分页插件
     */
    @Bean
    public PaginationInterceptor paginationInterceptor(){
        return new PaginationInterceptor();
    }
```



测试分页

```Java
    //分页查询
    @Test
    void testPage(){
        //创建page对象
        //传入两个参数 当前页和每页记录的数据
        Page<User> page = new Page(1,3);
        //调用分页查询方法
        IPage<User> userIPage = userMapper.selectPage(page, null);
        System.out.printf("数据：" + userIPage.getCurrent());//获取当前页
        System.out.printf("数据：" + userIPage.getRecords());//每页数据的list集合
        System.out.printf("数据：" + userIPage.getSize());//每页显示的记录数
        System.out.printf("数据：" + userIPage.getTotal());//总记录数
        System.out.printf("数据：" + userIPage.getPages());//总页数;
        System.out.printf("数据：" + page.hasNext());//是否有下一页
        System.out.printf("数据：" + page.hasPrevious());//是否有上一页
    }
```

#### 逻辑删除

物理删除：真实删除，将对应数据从数据库中删除，之后查询不到此条被删除的记录

逻辑删除：假删除，将对应数据中的代表是否被删除的字段，修改为**“被删除状态”**之后在数据库中仍旧能看到此条数据记录

在user表中添加逻辑删除字段 0表示正常，1表示删除

```java
    /**
     * 逻辑删除 0正常，
     */
    @TableLogic//逻辑删除注解
    private Integer deteled
```

增加逻辑删除插件

```Java
    /**
     * 逻辑删除插件
     */
    @Bean
    public ISqlInjector sqlInjector(){
        return new LogicSqlInjector();
    }
```

测试逻辑删除

```java
    //测试逻辑删除
    @Test
    void testLogic(){
        //userMapper.deleteById(1334040165173178369L);
        List<User> users = userMapper.selectList(null);
        users.forEach(System.out::println);
    }
```

- #### 性能分析插件

  ```java
      /**
       * 性能分析插件
       */
      @Bean
      //设置dev和测试环境时开启
      @Profile({"dev","test"})
      public PerformanceInterceptor performanceInterceptor (){
          PerformanceInterceptor performanceInterceptor = new PerformanceInterceptor();
          //超过此处设置的ms则不执行
          performanceInterceptor.setMaxTime(100);
          performanceInterceptor.setFormat(true);
          return performanceInterceptor;
      }
  ```

- 配置开发环境为dev环境

  ```
  #设置开发环境
  spring.profiles.active=dev
  ```

#### 条件构造器

复杂一点的条件查询

**前后端分离开发概念**：

前端：主要作用 数据显示

后端：主要作用 返回数据或操作数据

## 项目环境搭建

#### 开发讲师管理模块后端部分

创建讲师表edu_teacher

![image-20201203093744561](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201203093744561.png)



#### 创建项目结构

创建SpringBoot父工程 ：

![image-20201203094956706](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201203094956706.png)

修改pom文件，本项目采用的springboot版本为2.2.1

删除pom文件的依赖，添加确定好的依赖版本

```xml
<dependencyManagement>
    <dependencies>
        <!--Spring Cloud-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>Hoxton.RELEASE</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>${cloud-alibaba.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
        <!--mybatis-plus 持久层-->
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>${mybatis-plus.version}</version>
        </dependency>

        <!-- velocity 模板引擎, Mybatis Plus 代码生成器需要 -->
        <dependency>
            <groupId>org.apache.velocity</groupId>
            <artifactId>velocity-engine-core</artifactId>
            <version>${velocity.version}</version>
        </dependency>

        <!--swagger-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger2</artifactId>
            <version>${swagger.version}</version>
        </dependency>
        <!--swagger ui-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger-ui</artifactId>
            <version>${swagger.version}</version>
        </dependency>

        <!--aliyunOSS-->
        <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
            <version>${aliyun.oss.version}</version>
        </dependency>

        <!--日期时间工具-->
        <dependency>
            <groupId>joda-time</groupId>
            <artifactId>joda-time</artifactId>
            <version>${jodatime.version}</version>
        </dependency>

        <!--xls-->
        <dependency>
            <groupId>org.apache.poi</groupId>
            <artifactId>poi</artifactId>
            <version>${poi.version}</version>
        </dependency>
        <!--xlsx-->
        <dependency>
            <groupId>org.apache.poi</groupId>
            <artifactId>poi-ooxml</artifactId>
            <version>${poi.version}</version>
        </dependency>

        <!--文件上传-->
        <dependency>
            <groupId>commons-fileupload</groupId>
            <artifactId>commons-fileupload</artifactId>
            <version>${commons-fileupload.version}</version>
        </dependency>

        <!--commons-io-->
        <dependency>
            <groupId>commons-io</groupId>
            <artifactId>commons-io</artifactId>
            <version>${commons-io.version}</version>
        </dependency>

        <!--httpclient-->
        <dependency>
            <groupId>org.apache.httpcomponents</groupId>
            <artifactId>httpclient</artifactId>
            <version>${httpclient.version}</version>
        </dependency>

        <dependency>
            <groupId>com.google.code.gson</groupId>
            <artifactId>gson</artifactId>
            <version>${gson.version}</version>
        </dependency>

        <!-- JWT -->
        <dependency>
            <groupId>io.jsonwebtoken</groupId>
            <artifactId>jjwt</artifactId>
            <version>${jwt.version}</version>
        </dependency>

        <!--aliyun-->
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-java-sdk-core</artifactId>
            <version>${aliyun-java-sdk-core.version}</version>
        </dependency>
        <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
            <version>${aliyun-sdk-oss.version}</version>
        </dependency>
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-java-sdk-vod</artifactId>
            <version>${aliyun-java-sdk-vod.version}</version>
        </dependency>
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-java-vod-upload</artifactId>
            <version>${aliyun-java-vod-upload.version}</version>
        </dependency>
        <dependency>
            <groupId>com.aliyun</groupId>
            <artifactId>aliyun-sdk-vod-upload</artifactId>
            <version>${aliyun-sdk-vod-upload.version}</version>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>${fastjson.version}</version>
        </dependency>
        <dependency>
            <groupId>org.json</groupId>
            <artifactId>json</artifactId>
            <version>${json.version}</version>
        </dependency>

        <dependency>
            <groupId>commons-dbutils</groupId>
            <artifactId>commons-dbutils</artifactId>
            <version>${commons-dbutils.version}</version>
        </dependency>

        <dependency>
            <groupId>com.alibaba.otter</groupId>
            <artifactId>canal.client</artifactId>
            <version>${canal.client.version}</version>
        </dependency>
    </dependencies>
</dependencyManagement>
```

添加properyies确定依赖版本

```xml
<properties>
    <java.version>1.8</java.version>
    <guli.version>0.0.1-SNAPSHOT</guli.version>
    <mybatis-plus.version>3.0.5</mybatis-plus.version>
    <velocity.version>2.0</velocity.version>
    <swagger.version>2.7.0</swagger.version>
    <aliyun.oss.version>2.8.3</aliyun.oss.version>
    <jodatime.version>2.10.1</jodatime.version>
    <poi.version>3.17</poi.version>
    <commons-fileupload.version>1.3.1</commons-fileupload.version>
    <commons-io.version>2.6</commons-io.version>
    <httpclient.version>4.5.1</httpclient.version>
    <jwt.version>0.7.0</jwt.version>
    <aliyun-java-sdk-core.version>4.3.3</aliyun-java-sdk-core.version>
    <aliyun-sdk-oss.version>3.1.0</aliyun-sdk-oss.version>
    <aliyun-java-sdk-vod.version>2.15.2</aliyun-java-sdk-vod.version>
    <aliyun-java-vod-upload.version>1.4.11</aliyun-java-vod-upload.version>
    <aliyun-sdk-vod-upload.version>1.4.11</aliyun-sdk-vod-upload.version>
    <fastjson.version>1.2.28</fastjson.version>
    <gson.version>2.8.2</gson.version>
    <json.version>20170516</json.version>
    <commons-dbutils.version>1.7</commons-dbutils.version>
    <canal.client.version>1.1.0</canal.client.version>
    <docker.image.prefix>zx</docker.image.prefix>
    <cloud-alibaba.version>0.2.2.RELEASE</cloud-alibaba.version>
</properties>
```

创建子模块service

引入项目所需的依赖，不需要再确定版本

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-ribbon</artifactId>
    </dependency>

    <!--hystrix依赖，主要是用  @HystrixCommand -->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-hystrix</artifactId>
    </dependency>

    <!--服务注册-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    <!--服务调用-->
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-openfeign</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
    </dependency>

    <!--mysql-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
    </dependency>

    <!-- velocity 模板引擎, Mybatis Plus 代码生成器需要 -->
    <dependency>
        <groupId>org.apache.velocity</groupId>
        <artifactId>velocity-engine-core</artifactId>
    </dependency>

    <!--swagger-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
    </dependency>
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
    </dependency>

    <!--lombok用来简化实体类：需要安装lombok插件-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
    </dependency>

    <!--xls-->
    <dependency>
        <groupId>org.apache.poi</groupId>
        <artifactId>poi</artifactId>
    </dependency>

    <dependency>
        <groupId>org.apache.poi</groupId>
        <artifactId>poi-ooxml</artifactId>
    </dependency>

    <dependency>
        <groupId>commons-fileupload</groupId>
        <artifactId>commons-fileupload</artifactId>
    </dependency>

    <!--httpclient-->
    <dependency>
        <groupId>org.apache.httpcomponents</groupId>
        <artifactId>httpclient</artifactId>
    </dependency>
    <!--commons-io-->
    <dependency>
        <groupId>commons-io</groupId>
        <artifactId>commons-io</artifactId>
    </dependency>
    <!--gson-->
    <dependency>
        <groupId>com.google.code.gson</groupId>
        <artifactId>gson</artifactId>
    </dependency>

    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.12</version>
    </dependency>
</dependencies>
```

在子模块下面继续创建子模块service-edu(教育模块)

创建配置文件application.properties

```properties
#设置端口号
server.port=8001
#服务名
spring.application.name=service_edu
#设置环境
spring.profiles.active=dev
#数据库连接配置
spring.datasource.driver-class-name=com.mysql.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/yao_edu?useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimeZone=GMT%2B
spring.datasource.username=root
spring.datasource.password=123456
#Mybatis日志配置
mybatis-plus.configuration.log-impl=org.apache.ibatis.logging.stdout.StdOutImpl
```

#### mp代码生成器

使用mp提供的代码生成器，生成相关代码

```java
package com;

import com.baomidou.mybatisplus.annotation.DbType;
import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.generator.AutoGenerator;
import com.baomidou.mybatisplus.generator.config.DataSourceConfig;
import com.baomidou.mybatisplus.generator.config.GlobalConfig;
import com.baomidou.mybatisplus.generator.config.PackageConfig;
import com.baomidou.mybatisplus.generator.config.StrategyConfig;
import com.baomidou.mybatisplus.generator.config.rules.DateType;
import com.baomidou.mybatisplus.generator.config.rules.NamingStrategy;
import org.junit.Test;

/**
 * @author
 * @since 2018/12/13
 */
public class CodeGenerator {

    @Test
    public void run() {

        // 1、创建代码生成器
        AutoGenerator mpg = new AutoGenerator();

        // 2、全局配置
        GlobalConfig gc = new GlobalConfig();
        String projectPath = System.getProperty("user.dir");
        //输出目录
        gc.setOutputDir("D:\\yao_parent\\service\\service_edu" + "/src/main/java");
        gc.setAuthor("yaoheng");
        gc.setOpen(false); //生成后是否打开资源管理器
        gc.setFileOverride(false); //重新生成时文件是否覆盖
        gc.setServiceName("%sService");    //去掉Service接口的首字母I
        gc.setIdType(IdType.ID_WORKER_STR); //主键策略
        gc.setDateType(DateType.ONLY_DATE);//定义生成的实体类中日期类型
        gc.setSwagger2(true);//开启Swagger2模式

        mpg.setGlobalConfig(gc);

        // 3、数据源配置
        DataSourceConfig dsc = new DataSourceConfig();
        dsc.setUrl("jdbc:mysql://localhost:3306/yao_edu?useSSL=false&useUnicode=true&characterEncoding=UTF-8&serverTimeZone=GMT%2B");
        dsc.setDriverName("com.mysql.jdbc.Driver");
        dsc.setUsername("root");
        dsc.setPassword("123456");
        dsc.setDbType(DbType.MYSQL);
        mpg.setDataSource(dsc);

        // 4、包配置
        PackageConfig pc = new PackageConfig();
        pc.setModuleName("eduservice"); //模块名
        pc.setParent("com.yao");
        pc.setController("controller");
        pc.setEntity("entity");
        pc.setService("service");
        pc.setMapper("mapper");
        mpg.setPackageInfo(pc);

        // 5、策略配置
        StrategyConfig strategy = new StrategyConfig();
        strategy.setInclude("edu_teacher");
        strategy.setNaming(NamingStrategy.underline_to_camel);//数据库表映射到实体的命名策略
        strategy.setTablePrefix(pc.getModuleName() + "_"); //生成实体时去掉表前缀

        strategy.setColumnNaming(NamingStrategy.underline_to_camel);//数据库表字段映射到实体的命名策略
        strategy.setEntityLombokModel(true); // lombok 模型 @Accessors(chain = true) setter链式操作

        strategy.setRestControllerStyle(true); //restful api风格控制器
        strategy.setControllerMappingHyphenStyle(true); //url中驼峰转连字符

        mpg.setStrategy(strategy);


        // 6、执行
        mpg.execute();
    }
}
```

#### 编写第一个方法，查询所有的讲师

```java
/**
 * 查询所有讲师内容
 *
 * @return 讲师集合
 */
@GetMapping("/findAll")
public List<EduTeacher> getAllTeacher() {
    return eduTeacherService.list(null);
}
```

创建springboot启动类

```java
@SpringBootApplication
public class EduApplication {
    public static void main(String[] args) {
        SpringApplication.run(EduApplication.class,args);
    }
}
```

创建配置类EduMyConfig

添加@MapperScan注解，扫描mapper类下的文件

```java
@MapperScan("com.yao.eduservice.mapper")
```

启动springboot项目访问 http://localhost:8001/eduservice/edu_teacher/findAll

得到json类型的数据

![image-20201203145031131](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201203145031131.png)

统一返回的JSON时间格式

```properties
#配置统一的时间返回格式
spring.jackson.date-format=yyyy-MM-dd HH:mm:ss
spring.jackson.time-zone=GMT+8
```

#### 讲师删除功能(逻辑删除)

1. 添加逻辑删除插件

   ```java
   /**
    * 逻辑删除插件
    */
   @Bean
   public ISqlInjector sqlInjector(){
       return new LogicSqlInjector();
   }
   ```

2. 实体类字段添加@TableLogic注解

3. 编写方法

   ```java
   /**
    * 讲师删除方法
    *
    * @param id 讲师id
    * @return 是否成功
    */
   @DeleteMapping("{id}")
   public Boolean deleteTeacher(@PathVariable String id) {
   
       return eduTeacherService.removeById(id);
   }
   ```

4. 因为使用的是@DeleteMapping提交方式，所以我们使用swagger来测试

**整合swagger进行测试**

- 生成一个在线的接口文档
- 接口测试

在父工程中创建公共模块整合swagger

创建子模块common，引入依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
        <scope>provided </scope>
    </dependency>

    <!--mybatis-plus-->
    <dependency>
        <groupId>com.baomidou</groupId>
        <artifactId>mybatis-plus-boot-starter</artifactId>
        <scope>provided </scope>
    </dependency>

    <!--lombok用来简化实体类：需要安装lombok插件-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <scope>provided </scope>
    </dependency>

    <!--swagger-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <scope>provided </scope>
    </dependency>
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger-ui</artifactId>
        <scope>provided </scope>
    </dependency>

    <!-- redis -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-redis</artifactId>
    </dependency>

    <!-- spring2.X集成redis所需common-pool2
    <dependency>
        <groupId>org.apache.commons</groupId>
        <artifactId>commons-pool2</artifactId>
        <version>2.6.0</version>
    </dependency>-->
</dependencies>
```
在common中继续创建子模块service_base

创建配置类SwaggerConfig

```java
@Configuration
@EnableSwagger2
public class SwaggerConfig {
    @Bean
    public Docket webApiConfig() {
        return new Docket(DocumentationType.SWAGGER_2)
                .groupName("webApi")
                .apiInfo(webApiInfo())
                .select()
                .paths(Predicates.not(PathSelectors.regex("/admin/.*")))
                .paths(Predicates.not(PathSelectors.regex("/error.*")))
                .build();

    }

    private ApiInfo webApiInfo() {

        return new ApiInfoBuilder()
                .title("网站-课程中心API文档")
                .description("本文档描述了课程中心微服务接口定义")
                .version("1.0")
                .contact(new Contact("java", "http://atguigu.com", "1123@qq.com"))
                .build();
    }
}
```

在service模块中隐入依赖

```xml
        <dependency>
            <artifactId>service_base</artifactId>
            <groupId>com.yao</groupId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
```

在service_edu的启动类上添加包扫描规则

```java
@ComponentScan(basePackages = {"com.yao"})
```

启动项目访问http://localhost:8001/swagger-ui.html

![image-20201203155007884](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201203155007884.png)

#### 统一返回的数据格式

```json
"success" 布尔 //表示是否响应成功
"code" 数字 //响应码
"message" 字符串 //返回消息
"data" hashMap //键值对的数据
```

在common模块中创建子模块common_utils

使用接口定义固定的状态码

```java
/**
 * 访问成功状态码
 */
public static Integer SUCCESS = 20000;
/**
 * 访问失败状态码
 */
public static Integer ERROR = 20001;
```



创建返回结果类Result

```java
import java.util.Map;

/**
 * @author yaoheng
 * @date 2020/12/3 16:17
 */
@Data
public class Result {
    @ApiModelProperty(value = "是否成功")
    private Boolean success;
    @ApiModelProperty(value = "响应状态码")
    private Integer code;
    @ApiModelProperty(value = "返回消息")
    private String message;
    @ApiModelProperty(value = "返回数据")
    private Map<String, Object> data = new HashMap<String, Object>();

    /**
     * 私有化构造方法
     */
    private Result() {
    }

    /**
     * 成功静态方法
     *
     * @return 结果
     */
    public static Result ok() {
        Result result = new Result();
        result.setCode(ResultCode.SUCCESS);
        result.setMessage("成功");
        result.setSuccess(true);
        return result;
    }

    /**
     * 失败静态方法
     *
     * @return 结果
     */
    public static Result error() {
        Result result = new Result();
        result.setCode(ResultCode.ERROR);
        result.setMessage("失败");
        result.setSuccess(false);
        return result;
    }

    public Result message(String message) {
        this.setMessage(message);
        return this;
    }

    public Result code(Integer code) {
        this.setCode(code);
        return this;
    }

    public Result data(String key, Object value) {
        this.data.put(key, value);
        return this;
    }

    public Result data(Map<String, Object> map) {
        this.setData(map);
        return this;
    }

    public Result success(Boolean success) {
        this.setSuccess(success);
        return this;
    }
}
```

使用统一返回结果

引入依赖

```xml
<dependency>
    <groupId>com.yao</groupId>
    <artifactId>common_utils</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

更改统一返回结果

```java
@ApiOperation(value = "查询所有讲师")
@GetMapping("/findAll")
public Result getAllTeacher() {
    List<EduTeacher> list = eduTeacherService.list(null);
    return Result.ok().data("data", list);
}
```

测试

#### 分页查询

1. 配置mp分页插件

   ```java
   /**
    * 分页插件
    */
   @Bean
   public PaginationInterceptor paginationInterceptor(){
       return new PaginationInterceptor();
   }
   ```

2. 编写分页查询接口

   ```java
   /**
    * 分页查询
    *
    * @return Result
    */
   @ApiOperation(value = "分页查询讲师")
   @GetMapping("/getPageTeacher/{current}/{limit}")
   public Result getPageTeacher(@ApiParam(value = "当前页", required = true) @PathVariable Long current, @ApiParam(value = "每页记录数", required = true) @PathVariable Long limit) {
       Page<EduTeacher> page = new Page<>(current,limit);
       eduTeacherService.page(page,null);
       //总记录数
       Long total = page.getTotal();
       //数据list集合
       List<EduTeacher> records = page.getRecords();
       return Result.ok().data("total",total).data("rows",records);
   }
   ```

3. 测试

![image-20201203205706495](C:\Users\MACHENIKE\AppData\Roaming\Typora\typora-user-images\image-20201203205706495.png)

#### 讲师多条件组合分页查询

1. 创建封装对象类EduTeacherVo

   ```Java
   @Data
   public class EduTeacherVo {
       @ApiModelProperty(value = "讲师姓名,模糊查询")
       private String name;
       
       @ApiModelProperty(value = "头衔 1高级讲师 2首席讲师")
       private Integer level;
   
       @ApiModelProperty(value = "查询开始时间",example = "2020-12-03 21:08:08")
       private Date begin;
   
       @ApiModelProperty(value = "查询结束时间",example = "2020-12-03 21:08:08")
       private Date end;
   }
   ```

2. 编写多条件查询接口

3. ```java
   @ApiOperation(value = "多条件组合分页查询")
   @PostMapping("/getQueryTeacher/{current}/{limit}")
   @ApiImplicitParams({
           @ApiImplicitParam(name = "current", value = "当前页", paramType = "path", required = true, dataType = "Long"),
           @ApiImplicitParam(name = "limit", value = "每页记录数", paramType = "path", required = true, dataType = "Long"),
   })
   public Result getQueryTeacher(@PathVariable Long current, @PathVariable Long limit, @RequestBody(required = false) EduTeacherVo eduTeacherVo) {
       //创建分页对象
       Page<EduTeacher> teacherPage = new Page<>(current, limit);
       //创建构造条件
       QueryWrapper<EduTeacher> wrapper = new QueryWrapper<EduTeacher>();
       //判断条件是否为空，不为空拼接条件
       if (!StringUtils.isEmpty(eduTeacherVo.getName())) {
           wrapper.like("name", eduTeacherVo.getName());
       }
       if (!StringUtils.isEmpty(eduTeacherVo.getLevel())) {
           wrapper.eq("level", eduTeacherVo.getLevel());
       }
       if (!StringUtils.isEmpty(eduTeacherVo.getBegin())) {
           //大于等于创建时间
           wrapper.ge("gmt_create", eduTeacherVo.getBegin());
       }
       if (!StringUtils.isEmpty(eduTeacherVo.getEnd())) {
           //小于等于创建时间
           wrapper.le("gmt_create", eduTeacherVo.getEnd());
       }
       eduTeacherService.page(teacherPage, wrapper);
       Long total = teacherPage.getTotal();
       List<EduTeacher> records = teacherPage.getRecords();
       return Result.ok().data("total", total).data("rows", records);
   }
   ```

4. 测试

